/* =========================
CONFIG
========================= */
let CURRENT_CUSTOMER = null;
let CURRENT_BILLS = [];
const LIFF_ID = "2008883587-vieENd7j";
const FN_BASE =
  "https://gboocrkgorslnwnuhqic.supabase.co/functions/v1";

// ‚ùó anon key 
const SUPABASE_ANON_KEY =
  "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imdib29jcmtnb3JzbG53bnVocWljIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njc5MzYzMTUsImV4cCI6MjA4MzUxMjMxNX0.egN-N-dckBh8mCbY08UbGPScWv6lYpPCxodStO-oeTQ";

/* =========================
HELPER : API CALL
========================= */
async function callFn(path, payload) {
  const res = await fetch(`${FN_BASE}/${path}`, {
    method: "POST",
    headers: {
      "Content-Type": "application/json",
      Authorization: `Bearer ${SUPABASE_ANON_KEY}`,
    },
    body: JSON.stringify(payload),
  });

  if (!res.ok) {
    const text = await res.text();
    throw new Error(text);
  }
  return res.json();
}

function setButtonLoading(btn, text) {
  btn.classList.add("loading");
  btn.innerHTML = `
    <span class="spinner"></span>
    <span>${text}</span>
  `;
}

function resetButton(btn, text) {
  btn.classList.remove("loading");
  btn.innerText = text;
}

/* =========================
INIT
========================= */
async function init() {
  try {
    await liff.init({ liffId: LIFF_ID });

    // üîπ Debug mode (‡πÑ‡∏°‡πà‡πÄ‡∏õ‡∏¥‡∏î‡∏à‡∏≤‡∏Å LINE)
    if (!liff.isInClient()) {
      renderCard(`
        <div class="section-card">
          <h3>‚ö†Ô∏è Debug Mode</h3>
          <p>‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡πÄ‡∏õ‡∏¥‡∏î‡∏à‡∏≤‡∏Å LINE</p>
          <button class="primary-btn" onclick="showGuestForm()">
            ‡πÄ‡∏Ç‡πâ‡∏≤‡πÇ‡∏´‡∏°‡∏î‡∏ó‡∏î‡∏™‡∏≠‡∏ö
          </button>
        </div>
      `);
      return;
    }

    // üîπ ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà login
    if (!liff.isLoggedIn()) {
      liff.login();
      return;
    }

    // üîπ ‡πÑ‡∏î‡πâ profile ‡∏à‡∏≤‡∏Å LINE
    const profile = await liff.getProfile();

    // üîπ ‡πÄ‡∏ä‡πá‡∏Ñ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏à‡∏≤‡∏Å backend
    const status = await callFn("check_line_status", {
      line_user_id: profile.userId,
    });

    /* =========================
       GUEST (‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏ú‡∏π‡∏Å‡∏ö‡∏±‡∏ç‡∏ä‡∏µ)
    ========================= */
    if (status.status === "guest") {
      showGuestForm();
      return;
    }

    /* =========================
       MEMBER
    ========================= */
    CURRENT_CUSTOMER = status.customer;

    const consentStatus =
      status.customer?.consent_status || "pending";

    /* =========================
       REVOKED (‡∏ñ‡∏≠‡∏ô‡∏Ñ‡∏ß‡∏≤‡∏°‡∏¢‡∏¥‡∏ô‡∏¢‡∏≠‡∏°)
    ========================= */
    if (consentStatus === "revoked") {
      showModal(
        "‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡πÑ‡∏î‡πâ",
        "‡∏Ñ‡∏∏‡∏ì‡πÑ‡∏î‡πâ‡∏ñ‡∏≠‡∏ô‡∏Ñ‡∏ß‡∏≤‡∏°‡∏¢‡∏¥‡∏ô‡∏¢‡∏≠‡∏°‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•\n‡∏£‡∏∞‡∏ö‡∏ö‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÉ‡∏´‡πâ‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£‡πÑ‡∏î‡πâ"
      );

      const originalClose = closeModal;
      closeModal = function () {
        modal.style.display = "none";
        closeModal = originalClose;
        liff.closeWindow();
      };
      return;
    }

    /* =========================
       PENDING (‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÉ‡∏´‡πâ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏¢‡∏¥‡∏ô‡∏¢‡∏≠‡∏°)
    ========================= */
    if (consentStatus === "pending") {
      showConsentPage(CURRENT_CUSTOMER); // üëà ‡∏´‡∏ô‡πâ‡∏≤ PDPA (C2)
      return;
    }

    /* =========================
       ACCEPTED (‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡πÑ‡∏î‡πâ‡∏õ‡∏Å‡∏ï‡∏¥)
    ========================= */
    showMemberMenu(CURRENT_CUSTOMER);

  } catch (err) {
    showModal("‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î", err.message);
  }
}

init();

/* =========================
UI HELPERS
========================= */
function renderCard(html) {
  document.getElementById("app").innerHTML = html;
}

function showCheckingPopup() {
  showModal(
    "‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Å‡∏≤‡∏£‡∏ó‡∏≥‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£",
    "‡∏™‡∏±‡∏ç‡∏ç‡∏≤‡∏ô‡∏µ‡πâ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Å‡∏≤‡∏£‡∏ó‡∏≥‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£\n‡∏ó‡πà‡∏≤‡∏ô‡∏à‡∏∞‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡πÅ‡∏à‡πâ‡∏á‡∏†‡∏≤‡∏¢‡πÉ‡∏ô 24 ‡∏ä‡∏±‡πà‡∏ß‡πÇ‡∏°‡∏á"
  );
}

function showGuestForm() {
  renderCard(`
    <div class="section-card">

      <div style="text-align:center; margin-bottom:16px;">
        <h3 style="margin:0;">‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å KPOS</h3>
        <p style="font-size:14px;color:#6b7280;margin-top:6px;">
          ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ú‡∏π‡∏Å‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡∏Å‡∏±‡∏ö LINE
        </p>
      </div>

      <!-- ‡πÄ‡∏•‡∏Ç‡∏ö‡∏±‡∏ï‡∏£ / Passport -->
      <div style="margin-bottom:14px;">
        <label style="font-size:13px;color:#374151;">
          ‡πÄ‡∏•‡∏Ç‡∏ö‡∏±‡∏ï‡∏£‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏ä‡∏ô / Passport
        </label>
        <input
          id="id_card"
          placeholder="‡∏Å‡∏£‡∏≠‡∏Å‡πÄ‡∏•‡∏Ç‡∏ö‡∏±‡∏ï‡∏£‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏ä‡∏ô ‡∏´‡∏£‡∏∑‡∏≠ Passport"
          style="
            width:100%;
            height:44px;
            border-radius:10px;
            border:1px solid #e5e7eb;
            padding:0 12px;
            font-size:15px;
            margin-top:6px;
          "
        />
      </div>

      <!-- ‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£ -->
      <div style="margin-bottom:14px;">
        <label style="font-size:13px;color:#374151;">
          ‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£‡∏®‡∏±‡∏û‡∏ó‡πå
        </label>
        <input
          id="phone"
          inputmode="numeric"
          maxlength="10"
          placeholder="‡∏Å‡∏£‡∏≠‡∏Å‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£‡∏®‡∏±‡∏û‡∏ó‡πå"
          style="
            width:100%;
            height:44px;
            border-radius:10px;
            border:1px solid #e5e7eb;
            padding:0 12px;
            font-size:15px;
            margin-top:6px;
          "
        />
      </div>

      <!-- ‡∏¢‡∏≠‡∏°‡∏£‡∏±‡∏ö‡πÄ‡∏á‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏Ç -->
      <div style="display:flex;align-items:flex-start;gap:10px;margin-bottom:18px;">
        <input
          type="checkbox"
          id="acceptTerms"
          style="margin-top:4px;"
        />
        <label for="acceptTerms" style="font-size:13px;color:#374151;line-height:1.4;">
          ‡∏¢‡∏≠‡∏°‡∏£‡∏±‡∏ö‡πÄ‡∏á‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏Ç‡∏Å‡∏≤‡∏£‡πÉ‡∏´‡πâ‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£
        </label>
      </div>

      <!-- ‡∏õ‡∏∏‡πà‡∏° -->
      <button
        id="verifyBtn"
        class="primary-btn"
        onclick="verifyCustomer()"
        disabled
      >
        ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
      </button>

    </div>
  `);

  // ‡πÄ‡∏õ‡∏¥‡∏î/‡∏õ‡∏¥‡∏î‡∏õ‡∏∏‡πà‡∏°‡∏ï‡∏≤‡∏°‡∏Å‡∏≤‡∏£‡∏ï‡∏¥‡πä‡∏Å
  const checkbox = document.getElementById("acceptTerms");
  const btn = document.getElementById("verifyBtn");

  checkbox.addEventListener("change", () => {
    btn.disabled = !checkbox.checked;
  });
}

/* =========================
VERIFY CUSTOMER
========================= */

async function verifyCustomer() {
  const idCard = document.getElementById("id_card").value.trim();
  const phone = document.getElementById("phone").value.trim();
  const btn = document.getElementById("verifyBtn");

  if (!idCard || !phone) {
    showModal("‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡∏Ñ‡∏£‡∏ö", "‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö");
    return;
  }

  if (!/^\d{10}$/.test(phone)) {
    showModal("‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á", "‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£ 10 ‡∏´‡∏•‡∏±‡∏Å");
    return;
  }

  setButtonLoading(btn, "‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö");

  try {
    const result = await callFn("find_customer_for_line", {
      id_card: idCard,
      phone,
    });

    if (!result.found) {
      showModal("‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•", "‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤");
      return;
    }

    if (result.status !== "active") {
      showModal("‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡πÑ‡∏î‡πâ", result.message || "");
      return;
    }

    const profile = await liff.getProfile();
    const bind = await callFn("register_customer_with_line", {
      customer_id: result.customer_id,
      line_user_id: profile.userId,
    });

    if (bind.success) {
  showModal("‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à", "‡∏¢‡∏¥‡∏ô‡∏î‡∏µ‡∏ï‡πâ‡∏≠‡∏ô‡∏£‡∏±‡∏ö‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å KPOS");


  // üîπ set customer ‡πÉ‡∏´‡πâ session ‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô
  CURRENT_CUSTOMER = {
    customer_id: result.customer_id,
    name: result.name,
    phone: phone,
  };

  // üîπ ‡πÄ‡∏î‡πâ‡∏á‡πÄ‡∏Ç‡πâ‡∏≤ Home ‡∏´‡∏•‡∏±‡∏á‡∏à‡∏≤‡∏Å‡∏Å‡∏î‡∏ï‡∏Å‡∏•‡∏á
  const originalClose = closeModal;
  closeModal = function () {
    modal.style.display = "none";
    closeModal = originalClose;
    showMemberMenu(CURRENT_CUSTOMER);
  };
} else {
  showModal("‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à", "‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡πÑ‡∏î‡πâ");
}

  } catch (err) {
    showModal("‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î", err.message);
  } finally {

    resetButton(btn, "‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•");
  }
}

/* =========================
MEMBER MENU (UI ONLY)
========================= */
function showMemberMenu(customer) {
  const name = customer.name || "‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤ KPOS";
  const phone = maskPhone(customer.phone || "");

  renderCard(`
    <div class="app-page home-page">

      <!-- Header -->
      <div class="home-header">
        <div>
          <div class="home-title">‡∏´‡∏ô‡πâ‡∏≤‡∏´‡∏•‡∏±‡∏Å</div>
          <div class="home-sub">‡∏¢‡∏¥‡∏ô‡∏î‡∏µ‡∏ï‡πâ‡∏≠‡∏ô‡∏£‡∏±‡∏ö</div>
        </div>

        <div class="home-avatar">
          <span>üë§</span>
        </div>
      </div>

      <!-- Profile Card -->
      <div class="section-card">
        <div class="member-name">‡∏Ñ‡∏∏‡∏ì ${name}</div>
        <div class="member-phone">‡πÄ‡∏ö‡∏≠‡∏£‡πå: ${phone}</div>
      </div>

      <!-- Menu Grid -->
      <div class="menu-grid">

        <button class="menu-tile active" onclick="openMyBills(this)">
          <div class="tile-icon">üìÑ</div>
          <div class="tile-text">‡∏ö‡∏¥‡∏•‡∏Ç‡∏≠‡∏á‡∏â‡∏±‡∏ô</div>
        </button>

        <button class="menu-tile disabled" disabled>
          <div class="tile-icon">üí≥</div>
          <div class="tile-text">‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô</div>
        </button>

        <button class="menu-tile disabled" disabled>
          <div class="tile-icon">üì¶</div>
          <div class="tile-text">‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏≠‡∏∑‡πà‡∏ô</div>
        </button>

        <button class="menu-tile" onclick="openSettings()">
  <div class="tile-icon">‚öôÔ∏è</div>
  <div class="tile-text">‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤</div>
</button>

        <button class="menu-tile disabled" disabled>
          <div class="tile-icon">üìû</div>
          <div class="tile-text">‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠‡∏£‡πâ‡∏≤‡∏ô</div>
        </button>

        <button class="menu-tile disabled" disabled>
          <div class="tile-icon">üöß</div>
          <div class="tile-text">‡πÄ‡∏£‡πá‡∏ß ‡πÜ ‡∏ô‡∏µ‡πâ</div>
        </button>

      </div>
    </div>
  `);
}

/* =========================
MODAL
========================= */
function showModal(title, message) {
  modalTitle.innerText = title;
  modalMessage.innerText = message;
  modal.style.display = "flex";
}

function closeModal() {
  modal.style.display = "none";
}



/* =========================
ACTIONS
========================= */
function openPawn() { alert("‡πÑ‡∏õ‡∏´‡∏ô‡πâ‡∏≤‡∏Ç‡∏≤‡∏¢‡∏ù‡∏≤‡∏Å"); }
function openInstallment() { alert("‡πÑ‡∏õ‡∏´‡∏ô‡πâ‡∏≤‡∏ú‡πà‡∏≠‡∏ô"); }
function logout() { liff.logout(); location.reload(); }

/* =========================
HELPER
========================= */
function maskPhone(phone) {
  if (phone.length < 10) return phone;
  return phone.slice(0,3) + "*****" + phone.slice(-2);
}

function formatDate(dateStr) {
  if (!dateStr) return "-";
  const d = new Date(dateStr);
  const dd = String(d.getDate()).padStart(2, "0");
  const mm = String(d.getMonth() + 1).padStart(2, "0");
  const yyyy = d.getFullYear();
  return `${dd}-${mm}-${yyyy}`;
}

/* =========================
MENU ACTIONS
========================= */
function maskLast6(value) {
  if (!value) return "-";
  return "‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" + value.slice(-6);
}

async function openMyBills(btn) {
  // ‚úÖ ‡πÄ‡∏û‡∏¥‡πà‡∏°: loading ‡∏ö‡∏ô‡∏õ‡∏∏‡πà‡∏°
  setButtonLoading(btn, "‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î");

  try {
    const res = await callFn("get_my_pawn_bills", {
      customer_id: CURRENT_CUSTOMER.customer_id,
    });

    const bills = res.bills || [];
    CURRENT_BILLS = bills;

    renderCard(`
      <div class="top-bar">
        <button class="back-btn" onclick="showMemberMenu(CURRENT_CUSTOMER)">‚Üê</button>
        <div class="top-title">‡∏ö‡∏¥‡∏•‡∏Ç‡∏≠‡∏á‡∏â‡∏±‡∏ô</div>
      </div>

      <div class="bill-section">
        <h4>üì¶ ‡∏ö‡∏¥‡∏•‡∏Ç‡∏≤‡∏¢‡∏ù‡∏≤‡∏Å</h4>
        ${
          bills.length === 0
            ? `<p style="color:#888">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ù‡∏≤‡∏Å</p>`
            : bills.map((bill, i) => renderPawnBill(bill, i)).join("")
        }
      </div>
    `);

  } catch (err) {
    showModal("‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î", err.message || "‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÇ‡∏´‡∏•‡∏î‡∏ö‡∏¥‡∏•‡πÑ‡∏î‡πâ");
    resetButton(btn, "üìÑ ‡∏ö‡∏¥‡∏•‡∏Ç‡∏≠‡∏á‡∏â‡∏±‡∏ô");
  }
}

function renderPawnBill(bill, index) {
  const item = bill.pawn_items || {};

  const today = new Date();
  const dueDate = new Date(bill.due_date);

  const isOverdue = today > dueDate;

  const statusText = isOverdue ? "‡πÄ‡∏Å‡∏¥‡∏ô‡∏Å‡∏≥‡∏´‡∏ô‡∏î" : "‡∏õ‡∏Å‡∏ï‡∏¥";
  const statusClass = isOverdue
    ? "bill-status warning"
    : "bill-status";

  return `
    <div class="bill-card">
      <div class="bill-row" style="font-weight:600; display:flex; justify-content:space-between;">
        <span>‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà‡∏ö‡∏¥‡∏• ${bill.contract_no}</span>
        <span class="${statusClass}">${statusText}</span>
      </div>

      <!-- ‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ ‡∏ï‡πâ‡∏≠‡∏á‡∏≠‡∏¢‡∏π‡πà‡∏Å‡πà‡∏≠‡∏ô -->
      <div style="margin:10px 0;font-weight:600">
        ${item.brand || ""} ${item.model || ""}
      </div>

      <div class="bill-row">
        <span>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</span>
        <span>${formatDate(bill.deposit_date)}</span>
      </div>

      <div class="bill-row">
        <span>IMEI / SN</span>
        <span>${maskLast6(item.imei || item.sn)}</span>
      </div>

      <div class="bill-row">
        <span>‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏á‡∏¥‡∏ô</span>
        <span>${Number(bill.deposit_amount).toLocaleString()} ‡∏ö‡∏≤‡∏ó</span>
      </div>

      <div class="bill-row">
        <span>‡∏Ñ‡∏£‡∏ö‡∏Å‡∏≥‡∏´‡∏ô‡∏î</span>
        <span>${formatDate(bill.due_date)}</span>
      </div>

     ${
  bill.is_checking_payment
    ? `
      <button
        class="menu-btn secondary"
        style="margin-top:10px"
        onclick="showCheckingPopup()"
      >
        ‚è≥ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö
      </button>
    `
    : `
      <button
        class="menu-btn"
        style="margin-top:10px"
        onclick="openPawnPaymentByIndex(${index})"
      >
        üí≥ ‡∏ä‡∏≥‡∏£‡∏∞‡∏Ñ‡πà‡∏≤‡∏á‡∏ß‡∏î / ‡∏ï‡πà‡∏≠‡∏≠‡∏≤‡∏¢‡∏∏‡∏ö‡∏¥‡∏•
      </button>
    `
}


    </div>
  `;
}

function openPawnPayment(bill) {
  if (typeof openPayment !== "function") {
    showModal("‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î", "‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏´‡∏ô‡πâ‡∏≤ payment");
    return;
  }

  openPayment(bill);
}

function openPawnPaymentByIndex(index) {
  const bill = CURRENT_BILLS[index];

  if (!bill) {
    showModal("‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î", "‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏ö‡∏¥‡∏•‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å");
    return;
  }

  openPawnPayment(bill);
}
/* =========================
Settings Page
========================= */
function openSettings() {
  renderCard(`
    <div class="top-bar">
      <button class="back-btn" onclick="showMemberMenu(CURRENT_CUSTOMER)">‚Üê</button>
      <div class="top-title">‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤</div>
    </div>

    <div class="settings-card">

      <!-- ‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ -->
      <div class="menu-title" style="padding: 12px 18px 6px;">
        ‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ
      </div>

      <div class="settings-item"
           onclick="showModal('‡πÄ‡∏£‡πá‡∏ß ‡πÜ ‡∏ô‡∏µ‡πâ','‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏Å‡∏≤‡∏£‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô')">
        <div class="settings-icon">üîî</div>
        <div class="settings-text">‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏Å‡∏≤‡∏£‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô</div>
        <div class="settings-arrow">‚Ä∫</div>
      </div>
      <div class="settings-divider"></div>

      <div class="settings-item"
           onclick="showModal('‡∏Ñ‡∏ß‡∏≤‡∏°‡∏¢‡∏¥‡∏ô‡∏¢‡∏≠‡∏°','‡∏Å‡∏≤‡∏£‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏Ñ‡∏ß‡∏≤‡∏°‡∏¢‡∏¥‡∏ô‡∏¢‡∏≠‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•')">
        <div class="settings-icon">üë§</div>
        <div class="settings-text">‡∏Å‡∏≤‡∏£‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏Ñ‡∏ß‡∏≤‡∏°‡∏¢‡∏¥‡∏ô‡∏¢‡∏≠‡∏°</div>
        <div class="settings-arrow">‚Ä∫</div>
      </div>

      <!-- ‡∏Ç‡πâ‡∏≠‡∏Å‡∏≥‡∏´‡∏ô‡∏î -->
      <div class="menu-title" style="padding: 18px 18px 6px;">
        ‡∏Ç‡πâ‡∏≠‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡πÅ‡∏•‡∏∞‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏õ‡πá‡∏ô‡∏™‡πà‡∏ß‡∏ô‡∏ï‡∏±‡∏ß
      </div>

      <div class="settings-item"
           onclick="showModal('‡∏Ç‡πâ‡∏≠‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡πÅ‡∏•‡∏∞‡πÄ‡∏á‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏Ç','‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏Ç‡πâ‡∏≠‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô')">
        <div class="settings-icon">üìÑ</div>
        <div class="settings-text">‡∏Ç‡πâ‡∏≠‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡πÅ‡∏•‡∏∞‡πÄ‡∏á‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏Ç</div>
        <div class="settings-arrow">‚Ä∫</div>
      </div>

      <div class="settings-divider"></div>

<div class="settings-item"
     onclick="confirmRevokeConsent()">
  <div class="settings-icon">‚ö†Ô∏è</div>
  <div class="settings-text">‡∏ñ‡∏≠‡∏ô‡∏Ñ‡∏ß‡∏≤‡∏°‡∏¢‡∏¥‡∏ô‡∏¢‡∏≠‡∏°‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</div>
</div>



      <div class="settings-divider"></div>

      <!-- Logout -->
      <div class="settings-item"
           onclick="logout()">
        <div class="settings-icon">üö™</div>
        <div class="settings-text">‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö</div>
      </div>

    </div>
  `);
}

/* =========================
PDPA CONSENT UI
========================= */
function showConsentPage() {
  renderCard(`
    <div class="top-bar">
      <div class="top-title">‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏õ‡πá‡∏ô‡∏™‡πà‡∏ß‡∏ô‡∏ï‡∏±‡∏ß</div>
    </div>

    <div class="section-card">

      <div class="menu-title">
        ‡∏Å‡∏≤‡∏£‡∏Ç‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏¢‡∏¥‡∏ô‡∏¢‡∏≠‡∏°‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏Å‡πá‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡πà‡∏ß‡∏ô‡∏ö‡∏∏‡∏Ñ‡∏Ñ‡∏•
      </div>

      <div style="font-size:14px; color:#374151; line-height:1.6; margin-bottom:16px;">
        KPOS ‡∏à‡∏≥‡πÄ‡∏õ‡πá‡∏ô‡∏ï‡πâ‡∏≠‡∏á‡πÉ‡∏ä‡πâ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Ç‡∏≠‡∏á‡∏ó‡πà‡∏≤‡∏ô‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£ ‡πÄ‡∏ä‡πà‡∏ô
        ‡∏Å‡∏≤‡∏£‡∏ù‡∏≤‡∏Å‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ ‡∏Å‡∏≤‡∏£‡∏ú‡πà‡∏≠‡∏ô‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ ‡∏Å‡∏≤‡∏£‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏ö‡∏¥‡∏• ‡πÅ‡∏•‡∏∞‡∏Å‡∏≤‡∏£‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠‡∏£‡πâ‡∏≤‡∏ô‡∏Ñ‡πâ‡∏≤
      </div>

      <div style="font-size:14px; color:#374151; line-height:1.6; margin-bottom:16px;">
        <strong>‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡∏à‡∏±‡∏î‡πÄ‡∏Å‡πá‡∏ö</strong>
        <ul style="padding-left:18px; margin-top:8px;">
          <li>‡∏ä‡∏∑‡πà‡∏≠ ‚Äì ‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•</li>
          <li>‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£‡∏®‡∏±‡∏û‡∏ó‡πå</li>
          <li>‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏±‡∏ç‡∏ç‡∏≤‡πÅ‡∏•‡∏∞‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏ó‡∏≥‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</li>
        </ul>
      </div>

      <div style="display:flex; gap:10px; margin-bottom:20px;">
        <input type="checkbox" id="consentCheck" />
        <label for="consentCheck" style="font-size:14px;">
          ‡∏Ç‡πâ‡∏≤‡∏û‡πÄ‡∏à‡πâ‡∏≤‡∏¢‡∏¥‡∏ô‡∏¢‡∏≠‡∏°‡πÉ‡∏´‡πâ KPOS ‡πÄ‡∏Å‡πá‡∏ö‡πÅ‡∏•‡∏∞‡πÉ‡∏ä‡πâ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡πà‡∏ß‡∏ô‡∏ö‡∏∏‡∏Ñ‡∏Ñ‡∏•
        </label>
      </div>

      <button
  id="consentAcceptBtn"
  class="primary-btn"
  disabled
  onclick="acceptConsent()"
>
  ‡∏¢‡∏¥‡∏ô‡∏¢‡∏≠‡∏°‡πÅ‡∏•‡∏∞‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏ï‡πà‡∏≠
</button>

<button
  class="primary-btn secondary-btn"
  style="margin-top:12px"
  onclick="declineConsent()"
>
  ‡πÑ‡∏°‡πà‡∏¢‡∏¥‡∏ô‡∏¢‡∏≠‡∏°
</button>

    </div>
  `);

  const checkbox = document.getElementById("consentCheck");
  const btn = document.getElementById("consentAcceptBtn");

  checkbox.addEventListener("change", () => {
    btn.disabled = !checkbox.checked;
  });
}

async function acceptConsent() {
  try {
    const profile = await liff.getProfile();

    await callFn("accept_consent", {
      line_user_id: profile.userId,
    });

    showModal("‡∏Ç‡∏≠‡∏ö‡∏Ñ‡∏∏‡∏ì", "‡∏Ñ‡∏∏‡∏ì‡πÑ‡∏î‡πâ‡πÉ‡∏´‡πâ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏¢‡∏¥‡∏ô‡∏¢‡∏≠‡∏°‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß");

    const originalClose = closeModal;
    closeModal = function () {
      modal.style.display = "none";
      closeModal = originalClose;
      showMemberMenu(CURRENT_CUSTOMER);
    };

  } catch (err) {
    showModal("‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î", err.message || "‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ñ‡∏ß‡∏≤‡∏°‡∏¢‡∏¥‡∏ô‡∏¢‡∏≠‡∏°‡πÑ‡∏î‡πâ");
  }
}

function declineConsent() {
  showModal(
    "‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡πÑ‡∏î‡πâ",
    "‡∏´‡∏≤‡∏Å‡πÑ‡∏°‡πà‡∏¢‡∏¥‡∏ô‡∏¢‡∏≠‡∏° ‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏∞‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÉ‡∏´‡πâ‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£‡πÑ‡∏î‡πâ"
  );

  const originalClose = closeModal;
  closeModal = function () {
    modal.style.display = "none";
    closeModal = originalClose;
    liff.closeWindow();
  };
}

function confirmRevokeConsent() {
  showConfirmModal(
    "‡∏ñ‡∏≠‡∏ô‡∏Ñ‡∏ß‡∏≤‡∏°‡∏¢‡∏¥‡∏ô‡∏¢‡∏≠‡∏°",
    `‡∏´‡∏≤‡∏Å‡∏Ñ‡∏∏‡∏ì‡∏ñ‡∏≠‡∏ô‡∏Ñ‡∏ß‡∏≤‡∏°‡∏¢‡∏¥‡∏ô‡∏¢‡∏≠‡∏°:
‚Ä¢ ‡∏Ñ‡∏∏‡∏ì‡∏à‡∏∞‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÉ‡∏ä‡πâ‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£ KPOS ‡πÑ‡∏î‡πâ‡∏≠‡∏µ‡∏Å
‚Ä¢ ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏ù‡∏≤‡∏Å / ‡∏ú‡πà‡∏≠‡∏ô / ‡∏î‡∏π‡∏ö‡∏¥‡∏•
‚Ä¢ ‡∏Å‡∏≤‡∏£‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£‡∏ô‡∏µ‡πâ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏¢‡πâ‡∏≠‡∏ô‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏î‡πâ

‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£‡∏ï‡πà‡∏≠‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?`,
    revokeConsent // üëà ‡∏Å‡∏î‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô‡∏ñ‡∏∂‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏Å
  );
}

async function revokeConsent() {
  try {
    const profile = await liff.getProfile();

    await callFn("revoke_consent", {
      line_user_id: profile.userId,
    });

    showModal(
      "‡∏ñ‡∏≠‡∏ô‡∏Ñ‡∏ß‡∏≤‡∏°‡∏¢‡∏¥‡∏ô‡∏¢‡∏≠‡∏°‡πÅ‡∏•‡πâ‡∏ß",
      "‡∏£‡∏∞‡∏ö‡∏ö‡πÑ‡∏î‡πâ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡∏ñ‡∏≠‡∏ô‡∏Ñ‡∏ß‡∏≤‡∏°‡∏¢‡∏¥‡∏ô‡∏¢‡∏≠‡∏°‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢"
    );

    const originalClose = closeModal;
    closeModal = function () {
      modal.style.display = "none";
      closeModal = originalClose;
      liff.closeWindow(); // ‚õî ‡∏õ‡∏¥‡∏î‡∏ó‡∏±‡∏ô‡∏ó‡∏µ
    };

  } catch (err) {
    showModal(
      "‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î",
      err.message || "‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏ñ‡∏≠‡∏ô‡∏Ñ‡∏ß‡∏≤‡∏°‡∏¢‡∏¥‡∏ô‡∏¢‡∏≠‡∏°‡πÑ‡∏î‡πâ"
    );
  }
}

function showConfirmModal(title, message, onConfirm) {
  modalTitle.innerText = title;
  modalMessage.innerText = message;

  modal.innerHTML = `
    <div class="modal">
      <h4>${title}</h4>
      <p style="white-space:pre-line">${message}</p>

      <button class="primary-btn" id="confirmBtn">
        ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏ó‡∏≥‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£
      </button>

      <button
        class="menu-btn secondary"
        style="margin-top:8px"
        id="cancelBtn"
      >
        ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡∏ó‡∏≥‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£
      </button>
    </div>
  `;

  modal.style.display = "flex";

  document.getElementById("cancelBtn").onclick = () => {
    modal.style.display = "none"; // ‚ùå ‡πÑ‡∏°‡πà‡πÅ‡∏ï‡∏∞ backend
  };

  document.getElementById("confirmBtn").onclick = () => {
    modal.style.display = "none";
    onConfirm(); // ‚úÖ ‡∏Ñ‡πà‡∏≠‡∏¢‡πÑ‡∏õ‡πÅ‡∏ï‡∏∞ backend
  };
}